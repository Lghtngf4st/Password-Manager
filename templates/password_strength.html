{% extends "layout.html" %}

{% block title %}
    Password Strength
{% endblock %}

{% block main %}
    <div class="row justify-content-center">
        <div class="col-12 col-md-7 col-lg-6 text-start">
            <h1 class="h3 mb-2">
                Check Password Strength
            </h1>
            <p class="form-text mb-4">
                Type a password to see a strength score and suggestions. Your input is checked server-side via POST and is not placed in the URL.
            </p>

            <div class="mb-2">
                <label for="pw" class="form-label">Password</label>
                <input id="pw" type="password" class="form-control form-control-lg" placeholder="Type a password..." autocomplete="off">       
            </div>

            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="form-text">Strength</small>
                    <small id="strengthLabel" class="form-text">-</small>
                </div>

                <div class="progress" style="height: 10px;">
                    <div id="strengthBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="4" aria-valuenow="0"></div>
                </div>

                <ul id="strengthFeedback" class="small form-text mt-2 mb-0"></ul>
            </div>

            <div class="d-flex gap-2">
                <button id="clearBtn" class="btn btn-outline-secondary" type="button">Clear</button>
                <button id="toggleBtn" class="btn btn-outline-dark" type="button">Show</button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const pwInput = document.getElementById("pw");
            const clearBtn = document.getElementById("clearBtn");
            const toggleBtn = document.getElementById("toggleBtn");

            const labelEl = document.getElementById("strengthLabel");
            const barEl = document.getElementById("strengthBar");
            const feedbackEl = document.getElementById("strengthFeedback");
            
            function setFeedback(list) {
                feedbackEl.innerHTML = "";
                (list || []).forEach(msg => {
                    const li = document.createElement("li");
                    li.textContent = msg;
                    feedbackEl.appendChild(li);
                });
            }

            function render(score, label, feedback) {
                const pct = Math.max(0, Math.min(4, Number(score))) / 4 * 100;
                labelEl.textContent = label || "-";
                barEl.style.width = pct + "%";
                barEl.setAttribute("aria-valuenow", String(score ?? 0));
                setFeedback(feedback);
            }

            function renderEmpty() {
                render(0, "-", []);
            }

            async function fetchStrength(pw) {
                const form = new FormData();
                form.append("password", pw);

                const res = await fetch("/password_strength", {method: "POST", body: form});

                // If Flask returned an error page, this will throw; handled below
                return await res.json();
            }

            let timer = null;

            pwInput.addEventListener("input", () => {
                const pw = pwInput.value || "";
                if (timer) clearTimeout(timer);

                timer = setTimeout(async () => {
                    if (!pw) {
                        renderEmpty();
                        return;
                    }

                    try {
                        const data = await fetchStrength(pw);
                        render(data.score, data.label, data.feedback);
                    } catch (e) {
                        render(0, "Error", ["Could not evaluate password strength. Check the console/server logs."]);
                        console.error(e);
                    }
                }, 150);
            });

            clearBtn.addEventListener("click", () => {
                pwInput.value = "";
                renderEmpty();
                pwInput.focus();
            });

            toggleBtn.addEventListener("click", () => {
                const hidden = pwInput.type === "password";
                pwInput.type = hidden ? "text" : "password";
                toggleBtn.textContent = hidden ? "Hide" : "Show";
            });

            renderEmpty();
        })();
    </script>
{% endblock %}
